{% extends "base.html" %}

{% block title %}PDF to Word Converter{% endblock %}

{% block content %}
<div class="container">
    <h1><i class="fas fa-file-word"></i> PDF to Word Converter</h1>
    
    <div class="upload-area" id="uploadArea">
        <i class="fas fa-cloud-upload-alt"></i>
        <h3>Drag & Drop PDF File Here</h3>
        <p>or click to browse files</p>
        <input type="file" id="fileInput" accept=".pdf" style="display: none;">
    </div>
    
    <div id="fileInfo" style="display: none;">
        <p><strong>Selected File:</strong> <span id="fileName"></span> (<span id="fileSize"></span>)</p>
    </div>
    
    <div style="text-align: center;">
        <button id="convertBtn" class="btn" disabled>
            <i class="fas fa-magic"></i> Convert to Word
        </button>
    </div>
    
    <div class="progress-container" id="progressContainer">
        <p id="statusText">Processing...</p>
        <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
        </div>
        <p id="progressPercent">0%</p>
    </div>
    
    <div class="result-area" id="resultArea">
        <h3><i class="fas fa-check-circle"></i> Conversion Complete!</h3>
        <p>Your document has been converted with high accuracy.</p>
        <a href="#" id="downloadBtn" class="btn">
            <i class="fas fa-download"></i> Download Word File
        </a>
        <button id="convertAgainBtn" class="btn" style="background: var(--secondary);">
            <i class="fas fa-redo"></i> Convert Another File
        </button>
    </div>
</div>

<script>
    // DOM Elements
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const convertBtn = document.getElementById('convertBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const statusText = document.getElementById('statusText');
    const resultArea = document.getElementById('resultArea');
    const downloadBtn = document.getElementById('downloadBtn');
    const convertAgainBtn = document.getElementById('convertAgainBtn');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileInfo = document.getElementById('fileInfo');
    
    // Event Listeners
    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);
    convertBtn.addEventListener('click', startConversion);
    convertAgainBtn.addEventListener('click', resetConverter);
    
    // Drag and Drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--accent)';
        uploadArea.style.backgroundColor = 'rgba(247, 37, 133, 0.1)';
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = 'rgba(255, 255, 255, 0.3)';
        uploadArea.style.backgroundColor = 'transparent';
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'rgba(255, 255, 255, 0.3)';
        uploadArea.style.backgroundColor = 'transparent';
        
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            handleFileSelect();
        }
    });
    
    // Functions
    function handleFileSelect() {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            convertBtn.disabled = false;
        }
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    async function startConversion() {
        const file = fileInput.files[0];
        if (!file) return;
        
        // Show progress
        progressContainer.style.display = 'block';
        convertBtn.disabled = true;
        updateProgress(10, "Uploading file...");
        
        try {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch('/convert', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Conversion failed');
            }
            
            // Simulate processing steps
            await updateProgress(40, "Extracting text...");
            await updateProgress(70, "Processing layout...");
            await updateProgress(100, "Finalizing conversion...");
            
            // Show result
            resultArea.style.display = 'block';
            downloadBtn.href = `/download/${data.filename}`;
            downloadBtn.download = `converted_${data.original.replace('.pdf', '.docx')}`;
            
            // Scroll to result
            resultArea.scrollIntoView({ behavior: 'smooth' });
            
        } catch (error) {
            statusText.textContent = "Error: " + error.message;
            console.error("Conversion error:", error);
        }
    }
    
    function updateProgress(percent, message) {
        return new Promise(resolve => {
            setTimeout(() => {
                progressBar.style.width = percent + '%';
                progressPercent.textContent = percent + '%';
                statusText.textContent = message;
                resolve();
            }, 500);
        });
    }
    
    function resetConverter() {
        fileInput.value = '';
        fileInfo.style.display = 'none';
        progressContainer.style.display = 'none';
        resultArea.style.display = 'none';
        progressBar.style.width = '0%';
        progressPercent.textContent = '0%';
        convertBtn.disabled = true;
    }
</script>
{% endblock %}